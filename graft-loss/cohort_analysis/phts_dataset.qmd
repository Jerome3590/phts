---
title: "PHTS Feature Importance"
author: "R. Jerome Dixon"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 6
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
    default-image-extension: svg
    dpi: 600
---

## Overview


## Variable Usage and Data Leakage Prevention

**Critical: Proper variable exclusion to prevent data leakage**

- **Classification Models (LASSO, CatBoost)**:
  - Target: `outcome` (binary: 0 = survival, 1 = event by 1 year)
  - Exclude: `ptid_e`, `transplant_year`, `ev_time`, `ev_type`
  - Reason: `ev_time` and `ev_type` directly relate to the outcome

- **Survival Model (AORSF)**:
  - Target: `Surv(ev_time, outcome)` where `ev_time` = time to event, `outcome` = event indicator
  - Exclude: `ptid_e`, `transplant_year`, `ev_type`
  - Reason: `ev_type` is redundant with `outcome`

## Categorical Variable Handling

**Important: Proper one-hot encoding for categorical variables**

- **Why one-hot encoding?**:
  - **Preserves categorical relationships**: Each category gets its own binary indicator
  - **No ordinal assumptions**: "Male" and "Female" become separate variables, not 1 and 2
  - **Better model interpretation**: LASSO can select individual categories independently
  - **Standard practice**: Industry standard for categorical variables in ML

- **Implementation**: Using `model.matrix()` for automatic one-hot encoding
- **Benefits**: Prevents models from interpreting categorical variables as continuous with linear relationships

```{r echo=FALSE, warning=FALSE, message=FALSE}

library(here)
library(readr)
library(haven)
library(purrr)
library(dplyr)
library(glmnet)
library(caret)
library(yardstick)
library(janitor)
library(lubridate)
library(stringr)
library(tidyverse)
library(tibble)
library(DataExplorer)
library(DT)
library(data.table)
library(pROC)
library(survival)

# Load helper functions from helpers.R
source("helpers.R")
```


```{r echo=FALSE, warning=FALSE, message=FALSE}

wisotzkey_variables <- read_csv(here("..", "data","wisotzkey_variables.csv"), show_col_types = FALSE)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Set directory
data_dir <- here("..","data")

# List SAS files
sas_files <- list.files(data_dir, pattern = "\\.sas7bdat$", full.names = TRUE)

# Named list: file base names (without extension) as names
sas_data <- sas_files %>%
  set_names(~ tools::file_path_sans_ext(basename(.))) %>%
  map(read_sas)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

tx <- sas_data$transplant %>% janitor::clean_names()

```

### 1 Yr Survival Time with Follow Up

#### COA 1

```{r}

# 1 yr Survival

# 1-yr Survival setup with follow-up == event_time fix
# int_dead / int_graft_loss are event times in YEARS
# dtx_patient / graft_loss are 0/1 event indicators
# 1-yr classification labels (observed-only)
# Label = 1 if event by 1 year; 0 if no event and follow-up reaches 1 year; else NA (drop)

### COA 1

tx <- tx %>%
  mutate(
    ev_time = pmin(int_dead, int_graft_loss, na.rm = TRUE),
    ev_type = pmax(dtx_patient, graft_loss, na.rm = TRUE),
    outcome = case_when(
      ev_type == 1 & ev_time < 1 ~ 1L,
      ev_type == 0 & ev_time < 1 ~ NA_integer_,
      TRUE ~ 0L
    )
  ) 

```

#### COA 2

```{r}

# COA 2: Only use patients whose transplants (TXPL_YEAR) were before 2023. This ensures everyone has a full year under observation.
tx <- tx %>%
  mutate(
    ev_time = pmin(int_dead, int_graft_loss, na.rm = TRUE),
    ev_type = pmax(dtx_patient, graft_loss, na.rm = TRUE),
    outcome = case_when(
      ev_type == 1 & ev_time < 1 ~ 1L,
      ev_type == 0 & ev_time < 1 ~ NA_integer_,
      TRUE ~ 0L
    )
  ) %>%
  filter(!is.na(outcome)) %>%
  filter(txpl_year < 2023)

```

#### COA 3 Use IPWC weighted data. https://www.medrxiv.org/content/10.1101/2025.08.22.25334253v1.full.pdf
This method requires all models to accept event weights. 

```{r}

```



### Wisotzkey Variables

```{r echo=FALSE, warning=FALSE, message=FALSE}

wisotzkey_vars <- wisotzkey_variables[[1]] %>% as.character()
wisotzkey_clean <- tolower(gsub("[^a-zA-Z0-9]+", "_", wisotzkey_vars))

```

```{r echo=FALSE}

# Calculate BMI, eGFR, and Listing Year
tx <- tx %>%
  mutate(
    age_listing = as.double(age_listing),
    age_txpl = as.double(age_txpl),
    bmi_txpl = (weight_txpl / (height_txpl^2)) * 703,
    egfr_tx = 0.413 * height_txpl / txcreat_r,
    listing_year = as.integer(floor(txpl_year - (age_txpl - age_listing)))
  )

```

```{r eval=FALSE}
tx_features <- tx %>% colnames()
write.csv(tx_features, "tx_variables.csv", row.names = FALSE)

```

```{r echo=FALSE}

wisotzkey_name_map <- c(
  "primary_etiology"               = "prim_dx",
  "mcsd_at_transplant"             = "txmcsd",
  "single_ventricle_chd"           = "chd_sv",
  "surgeries_prior_to_listing"     = "hxsurg",
  "serum_albumin_at_transplant"    = "txsa_r",
  "bun_at_transplant"              = "txbun_r",
  "ecmo_at_transplant"             = "txecmo",
  "transplant_year"                = "txpl_year",
  "recipient_weight_at_transplant" = "weight_txpl",
  "alt_at_transplant"              = "txalt",
  "bmi_at_transplant"              = "bmi_txpl",     # computed
  "pra_max_at_listing"             = "lsfprat",      # fallback: use lsfprab if missing
  "egfr_at_transplant"             = "egfr_tx",      # computed from height/creatinine
  "medical_history_at_listing"     = "hxmed",
  "listing_year"                   = "listing_year"  # computed from txpl_year, age_listing, age_txpl
)

```

```{r eval=FALSE}

tx$sec_dx %>% 
  unique()

```

### Functional Variables

```{r echo=FALSE}

cardiomyopathy_types <- c("Dilated", "Restrictive", "Hypertrophic", "ARVD/C", "Other", "MIXED")


tx <- tx %>%
  mutate(
    bmi_txpl = (weight_txpl / (height_txpl^2)) * 703,
    egfr_tx = 0.413 * height_txpl / txcreat_r,
    listing_year = as.integer(floor(txpl_year - (age_txpl - age_listing))),

    # Kidney Function
    creat_tx = txcreat_r,
    creat_list = lcreat_r,
    hx_dialysis = as.integer(hxdysdia == 1),
    hx_renal_insuff = as.integer(hxrenins == 1),

    # Liver Function
    ast_tx = txast,
    alt_tx = txalt,
    ast_list = lsast,
    alt_list = lsalt,
    bili_d_tx = txbili_d_r,
    bili_t_tx = txbili_t_r,
    bili_d_list = lsbili_d_r,
    bili_t_list = lsbili_t_r,
    fontan_liver_disease = as.integer(hxfonlvr == 1),

    # Nutrition
    prealbumin_tx = txpalb_r,
    prealbumin_list = lspalb_r,
    albumin_tx = txsa_r,
    albumin_list = lssab_r,
    total_protein_tx = txtp_r,
    total_protein_list = lstp_r,
    failure_to_thrive = as.integer(hxfail == 1),

    # Respiratory
    vent_tx = as.integer(txvent == 1),
    vent_list = as.integer(slvent == 1),
    trach_tx = as.integer(ltxtrach == 1),
    trach_list = as.integer(hxtrach == 1),

    # Cardiac
    vad_tx = as.integer(txvad == 1),
    vad_list = as.integer(slvad == 1),
    no_mcsd_list = as.integer(slnomcsd == 1),
    ecmo_tx = as.integer(txecmo == 1),
    ecmo_list = as.integer(slecmo == 1),
    hx_cpr = as.integer(hxcpr == 1),
    hx_shock = as.integer(hxshock == 1),

    # Immunology
    hla_tx_pre = as.integer(hlatxpre == 1),
    donor_crossmatch = as.integer(donspac == 1),
    pra_tx = txfcpra,
    pra_list = lsfcpra,

    # Genetic Syndromes
    gs_turner = as.integer(hxturner == 1),
    gs_shone = as.integer(chd_shone == 1),
    gs_costello = as.integer(hxcostlo == 1),
    gs_cardiofaciocutaneous = as.integer(hxcrd == 1),
    gs_digeorge = as.integer(hxdigorg == 1),
    gs_downs = as.integer(hxdowns == 1),
    gs_leopard = as.integer(hxleoprd == 1),
    gs_noonan = as.integer(hxnoonan == 1),

    # Diagnosis
    chd_sv = as.integer(chd_sv == 1),
    chd_heterotaxy = as.integer(chd_heter == 1),
    hx_surgery = as.integer(hxsurg == 1),
    dx_cardiomyopathy = case_when(
      sec_dx %in% cardiomyopathy_types ~ 1L,
      sec_dx %in% c("Unknown") | is.na(sec_dx) ~ NA_integer_,
      TRUE ~ 0L
    )

  )


```


```{r echo=FALSE}

# Impute values per Wisotzkey paper
tx_model <- tx %>%
  mutate(
    prim_dx = ifelse(is.na(prim_dx), "cardiomyopathy", prim_dx),
    txmcsd = ifelse(is.na(txmcsd), 0L, txmcsd),
    chd_sv = ifelse(is.na(chd_sv), 0L, chd_sv),
    hxsurg = ifelse(is.na(hxsurg), 0L, hxsurg),
    txsa_r = ifelse(is.na(txsa_r), 3.7, txsa_r),
    txbun_r = ifelse(is.na(txbun_r), 16, txbun_r),
    txecmo = ifelse(is.na(txecmo), 0L, txecmo),
    txpl_year = ifelse(is.na(txpl_year), 2015, txpl_year),
    weight_txpl = ifelse(is.na(weight_txpl), 35, weight_txpl),
    txalt = ifelse(is.na(txalt), 29, txalt),
    bmi_txpl = ifelse(is.na(bmi_txpl), 17, bmi_txpl),
    lsfprat = ifelse(is.na(lsfprat), 0, lsfprat),
    egfr_tx = ifelse(is.na(egfr_tx), 97, egfr_tx),
    hxmed = ifelse(is.na(hxmed), 1L, hxmed),
    listing_year = ifelse(is.na(listing_year), 2014, listing_year)
  ) %>%
  rename(!!!setNames(wisotzkey_name_map, names(wisotzkey_name_map))) 

```

```{r echo=FALSE}

tx_model <- tx_model %>%
  mutate(
    serum_albumin_at_transplant_bin = as.integer(serum_albumin_at_transplant > 3.7),
    pra_max_at_listing_bin          = as.integer(pra_max_at_listing > 0),
    alt_at_transplant_bin           = as.integer(alt_at_transplant > 29),
    single_ventricle_chd_bin        = as.integer(single_ventricle_chd > 0),
    egfr_at_transplant_bin          = as.integer(egfr_at_transplant > 97),
    bun_at_transplant_bin           = as.integer(bun_at_transplant > 16),
    bmi_at_transplant_bin           = as.integer(bmi_at_transplant > 17),
    dsecaccs_bin                    = as.integer(dsecaccs == "Cerebrovascular accident")
  ) %>%
  relocate(
    serum_albumin_at_transplant_bin,
    pra_max_at_listing_bin,
    alt_at_transplant_bin,
    single_ventricle_chd_bin,
    egfr_at_transplant_bin,
    bun_at_transplant_bin,
    bmi_at_transplant_bin,
    .after = medical_history_at_listing
  )

```

### Model Data

```{r echo=FALSE}

tx_model_features <- tx_model %>% 
  colnames()

tx_model_features

```

sec_dx values for Cardiomyopathy types:

```{r echo=FALSE}

tx_model$sec_dx %>% 
  unique()

```

```{r eval=FALSE, echo=FALSE}
# Distribution of numeric variables
plot_density(tx_model)  # Shows by default for all numeric vars
```

```{r eval=FALSE, echo=FALSE}
# Bar plots of factor levels
plot_bar(tx_model)

```

### Missing Data

-   Based on how data collected..treating "" as "Empty". Will perform further research and analysis where "Empty" shows up as important in our models.

```{r}

# Create two logging lists
converted_vars_log <- list()
skipped_vars_log <- list()

# Process character columns
char_vars <- tx_model %>% 
  select(where(is.character))

char_vars %>%
  names() %>%
  walk(function(var_name) {
    # Standardize to character (safe here, already character)
    vals <- as.character(tx_model[[var_name]])
    
    # Replace empty strings
    vals[vals == ""] <- "Empty"
    
    if (length(unique(vals)) > 1) {
      tx_model[[var_name]] <<- factor(vals)
      converted_vars_log[[var_name]] <<- levels(tx_model[[var_name]])
    } else {
      skipped_vars_log[[var_name]] <<- unique(vals)
    }
  })

# Process factor columns with only one level
factor_vars <- tx_model %>% 
  select(where(is.factor))

factor_vars %>%
  names() %>%
  walk(function(var_name) {
    if (nlevels(tx_model[[var_name]]) == 1) {
      # Convert to character
      vals <- as.character(tx_model[[var_name]])
      
      # Replace empty strings
      vals[vals == ""] <- "Empty"
      
      if (length(unique(vals)) > 1) {
        tx_model[[var_name]] <<- factor(vals)
        converted_vars_log[[var_name]] <<- levels(tx_model[[var_name]])
      } else {
        skipped_vars_log[[var_name]] <<- unique(vals)
      }
    }
  })

# Convert logs to character-safe tibbles
converted_df <- tibble(
  variable = names(converted_vars_log),
  unique_values = sapply(converted_vars_log, function(x) paste(sort(unique(as.character(x))), collapse = ", "))
)

skipped_df <- tibble(
  variable = names(skipped_vars_log),
  unique_values = sapply(skipped_vars_log, function(x) paste(sort(unique(as.character(x))), collapse = ", "))
)


write.csv(converted_df, "converted_vars_log.csv", row.names = FALSE)

write.csv(skipped_df, "skipped_vars_log.csv", row.names = FALSE)


```

```{r}

# View 
datatable(
  converted_df,
  rownames = FALSE,
  options = list(
    pageLength = 15,
    columnDefs = list(
      list(className = 'dt-left', targets = "_all")
    )
  )
)

```

```{r}

tx_model <- tx_model %>%
  mutate(across(c(donspxm, drhtype), ~ {
    x <- as.character(.)             # ensure character
    x[x == "+"] <- "positive_+"
    x[x == "-"] <- "negative_-"
    factor(x)                        # convert back to factor
  }))


```

```{r}
# Missing data visualization
missing_plot <- plot_missing(tx_model)

```

```{r}

# Get the names of columns with missing values
columns_with_missing <- missing_plot$data[missing_plot$data$pct_missing > .8]

# View 
datatable(
  columns_with_missing,
  rownames = FALSE,
  options = list(
    pageLength = 15,
    columnDefs = list(
      list(className = 'dt-left', targets = "_all")
    )
  )
)

```

```{r}

engineered_vars <- c(
  "bmi_txpl", "egfr_tx", "listing_year",
  "creat_tx", "creat_list", "hx_dialysis", "hx_renal_insuff",
  "ast_tx", "alt_tx", "ast_list", "alt_list",
  "bili_d_tx", "bili_t_tx", "bili_d_list", "bili_t_list", "fontan_liver_disease",
  "prealbumin_tx", "prealbumin_list", "albumin_tx", "albumin_list",
  "total_protein_tx", "total_protein_list", "failure_to_thrive",
  "vent_tx", "vent_list", "trach_tx", "trach_list",
  "vad_tx", "vad_list", "no_mcsd_list", "ecmo_tx", "ecmo_list",
  "hx_cpr", "hx_shock",
  "hla_tx_pre", "donor_crossmatch", "pra_tx", "pra_list",
  "gs_turner", "gs_shone", "gs_costello", "gs_cardiofaciocutaneous",
  "gs_digeorge", "gs_downs", "gs_leopard", "gs_noonan",
  "chd_sv", "chd_heterotaxy", "hx_surgery", "dx_cardiomyopathy",
  "serum_albumin_at_transplant_bin", "pra_max_at_listing_bin",
  "alt_at_transplant_bin", "single_ventricle_chd_bin",
  "egfr_at_transplant_bin", "bun_at_transplant_bin", "bmi_at_transplant_bin",
  "dsecaccs_bin"
)

# Column names with >80% missingness
columns_filtered_missing <- missing_plot$data %>%
  filter(pct_missing > 0.8) %>%
  pull(feature)

# Engineered vars with high missingness
high_missing_engineered_vars <- intersect(engineered_vars, columns_filtered_missing)


cat("Number of engineered variables with >80% missingness:", length(high_missing_engineered_vars), "\n")
print(high_missing_engineered_vars)

```

```{r}

# Get the names of columns with missing values
columns_with_missing <- missing_plot$data[missing_plot$data$pct_missing > .8]

# Extract the character vector of feature values
missing_rows <- as.character(columns_with_missing$feature)

# Filter out columns that aren't in tx_model
valid_missing <- intersect(missing_rows, colnames(tx_model))

# Drop only the valid missing columns
tx_model <- tx_model %>%
  select(-all_of(valid_missing))

```

### Stale Data (no initial variation - need to recode)

```{r}

# Identify factor or character columns
char_or_factor_cols <- names(tx_model)[sapply(tx_model, function(col) {
  is.character(col) || is.factor(col)
})]

# Convert NA and "" to "Missing", and ensure factors
tx_model <- tx_model %>%
  mutate(across(all_of(char_or_factor_cols), ~ {
    x <- as.character(.)
    x[is.na(x) | trimws(x) == ""] <- "Missing"
    factor(x)
  }))


summary(tx_model[char_or_factor_cols])

```

```{r}

# frequency tables for factors
tx_model <- tx_model %>%
  mutate(across(where(~ is.character(.) || is.logical(.)), as.factor))


factor_cols <- names(tx_model)[sapply(tx_model, is.factor)]
freq_tables <- lapply(tx_model[factor_cols], function(col) {
  as.data.frame(table(col, useNA = "ifany"))
})
names(freq_tables) <- factor_cols

```

### [CDC Data](https://github.com/CDC-DNPAO/CDCAnthro)

```{r eval=FALSE}
install.packages( 'https://raw.github.com/CDC-DNPAO/CDCAnthro/master/cdcanthro_0.1.3.tar.gz', type='source', repos=NULL )
```

Input variables for CDC Growth Charts:\
-weight_txpl (kg)\
-height_txpl (cm)\
-age_listing (years). Multiply by 12 and add 6 for months\
-Sex coded as 1 for Male, 2 for Female\
-bmi_txpl

```{r warning=FALSE, message=FALSE}

library(cdcanthro)

tx_model <- tx_model %>%
  mutate(
    age_in_months = age_listing * 12 + 6,
    weight_kgs = weight_listing * 0.453592,
    height_cm = height_listing * 2.54,
    sex = recode(as.character(sex), "M" = 1L, "F" = 2L) %>% as.integer()
  ) %>%
  as.data.frame()

orig_cols <- names(tx_model)

tx_model <- cdcanthro(tx_model, age = age_in_months, wt = weight_kgs, ht = height_cm, bmi = bmi_txpl, all = TRUE)


# CDC added data column names
new_cols <- setdiff(names(tx_model), orig_cols)
cat("New CDC columns added:\n")
print(new_cols)

```

### Final Updated Model Data

```{r}

# Clean the modeling data ===
tx_model <- tx_model %>%
  # Replace NAs in numeric columns with 0
  mutate(across(where(is.numeric), ~ replace_na(., 0))) %>%
  
  # Replace NAs in character/factor columns with "None"
  mutate(across(where(~ is.character(.) || is.factor(.)), ~ replace_na(as.character(.), "None"))) %>%
  
  # Reconvert characters back to factor (important if factors needed for modeling)
  mutate(across(where(is.character), as.factor))

# Export modeling dataset (includes ev_time and ev_type for survival models, cdc data fields)

tx_model_updated_features <- tx_model %>% 
  colnames()

write_csv(tx_model, "preprocessed_model_data_coa2.csv")
write.csv(tx_model_updated_features, "tx_model_variables.csv", row.names = FALSE)

```

```{r}

# COA 1 and COA 3 exports derived from engineered dataset
# - COA 1: Observed-only 1-year labels
# - COA 3: IPCW-weighted labels for 1-year horizon (tau = 1 year)

# Safety: ensure key columns exist
required_cols <- c("ptid_e", "ev_time", "ev_type")
missing_required <- setdiff(required_cols, names(tx_model))
if (length(missing_required)) {
  stop(paste("Missing required columns in tx_model:", paste(missing_required, collapse = ", ")))
}

# COA 1 labels (drop patients censored before 1 year)
model_coa1 <- tx_model %>%
  mutate(
    outcome = case_when(
      ev_type == 1 & ev_time < 1 ~ 1L,
      ev_time >= 1               ~ 0L,
      TRUE                       ~ NA_integer_
    )
  ) %>%
  filter(!is.na(outcome))

write_csv(model_coa1, "preprocessed_model_data_coa1.csv")


# COA 3: IPCW-weighted labels for 1-year horizon
# Define censoring as outcome == 0 (no event observed)
# KM for censoring survival G(t)
km_censor <- survfit(Surv(ev_time, as.integer(ev_type == 0)) ~ 1, data = tx_model)

# Helper to read G_hat(t) from KM curve
get_Ghat <- function(t_vec) {
  # summary(..., times=..., extend=TRUE) returns last value carried forward
  s <- summary(km_censor, times = t_vec, extend = TRUE)
  g <- as.numeric(s$surv)
  g[!is.finite(g) | is.na(g)] <- 1
  g
}

model_coa3 <- tx_model %>%
  mutate(
    # 1-year label identical to COA 1
    outcome = case_when(
      ev_type == 1 & ev_time < 1 ~ 1L,
      ev_time >= 1               ~ 0L,
      TRUE                       ~ NA_integer_
    ),
    # Time used in G(t): event time for events before 1y; tau for non-events
    .tau = 1,
    .t_ipcw = if_else(!is.na(outcome) & outcome == 1L, pmin(ev_time, .tau), .tau),
    .G = get_Ghat(.t_ipcw),
    ipcw_weight = 1 / pmax(.G, .Machine$double.eps)
  ) %>%
  filter(!is.na(outcome)) %>%
  select(-.tau, -.t_ipcw, -.G)

write_csv(model_coa3, "preprocessed_model_data_coa3.csv")

```

