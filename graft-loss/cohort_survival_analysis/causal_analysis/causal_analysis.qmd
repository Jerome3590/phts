---
title: "Causal Analysis: LMTP and FFA Starters"
author: "PHTS Analysis"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 4
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
    default-image-extension: svg
    dpi: 600
editor:
  markdown:
    wrap: 72
---

## Overview

This document provides starter code to run two complementary approaches:

- LMTP for estimating causal effects of time-varying treatment policies
  on survival
- FFA for model-level explanation of a trained CatBoost model

See `README.md` for goals, assumptions, and tradeoffs.

## Setup

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(survival)
library(DT)

# LMTP stack
suppressWarnings({
  suppressPackageStartupMessages({
    library(lmtp)
    library(sl3)   # learners
    library(origami) # cross-fitting
  })
})

# Local helpers
source("scripts/R/classification_helpers.R")

set.seed(1997)
```

## Data loading

```{r}
# Load transplant and follow-up data
tx <- load_phts_transplant_dataset()

# Example outcome construction consistent with survival models
model_data <- tx %>%
  mutate(
    outcome = as.integer(ev_type == 1),
    ev_time = suppressWarnings(as.numeric(ev_time))
  ) %>%
  fix_non_positive_times(time_col = "ev_time", status_col = "outcome")

cat("N=", nrow(model_data), "\n")
```

## LMTP starter: policy definition and nodes

The following chunk sketches an LMTP setup. You must specify nodes per
visit k: L_k, A_k, C_k, and the modified policy d(A_k | L_k).

```{r}
# Example: build a rudimentary longitudinal table (placeholder)
# Replace with engineered follow-up table derived from posttxplfollowup.sas7bdat

# pseudo_followup <- build_longitudinal_nodes(tx, posttxplfollowup)
# Columns typical structure: id, t, L1..Lp, A, C, Y, time

# Define a simple modified treatment policy function
policy_fun <- function(a, l) {
  # Example: reduce treatment if a numeric lab (e.g., creatinine) exceeds threshold
  # Return modified A* of same type as a
  a
}

# Learners (nuisance): choose flexible defaults via sl3
library(sl3)
lrn_glm <- Lrnr_glm$new()
lrn_xgb <- tryCatch(Lrnr_xgboost$new(nrounds = 200), error = function(e) lrn_glm)
sl <- Lrnr_sl$new(learners = Stack$new(lrn_glm, lrn_xgb))

# Placeholder call showing LMTP interface (commented until nodes are real)
# res_lmtp <- lmtp_tmle(
#   data = pseudo_followup,
#   outcome = "Y",
#   treatment = "A",
#   time = "t",
#   baseline = c("id"),
#   covariates = function(t) grep(paste0("^L", t, "_"), names(pseudo_followup), value = TRUE),
#   cens = "C",
#   shift = policy_fun,
#   learners_outcome = sl,
#   learners_treatment = sl,
#   learners_censoring = sl,
#   folds = origami::make_folds(n = nrow(pseudo_followup), V = 5)
# )

# print(summary(res_lmtp))
```

## FFA starter: explain CatBoost model

This section demonstrates calling the existing Python-based FFA tools to
analyze a trained CatBoost model.

```{python}
# Minimal FFA pipeline example: requires trained CatBoost and data paths
from cohort_analysis.ffa_analysis.catboost_axp_explainer import PathConfig, AnalysisConfig, analyze_model
from catboost import CatBoostClassifier
import os

# Configure paths (update these to your environment)
age_band = "all"
base_dir = os.path.join("cohort_analysis", "ffa_analysis")
pc = PathConfig(
    model_path=os.path.join(base_dir, "models", "catboost_model.cbm"),
    data_dir=os.path.join(base_dir, "data"),
    output_dir=os.path.join(base_dir, "outputs"),
    tree_rules_path=os.path.join(base_dir, "models", "tree_rules.json"),
    age_band=age_band,
)

# Load a CatBoost model if available; else skip
results = None
try:
    model = CatBoostClassifier()
    model.load_model(pc.model_path)
    results = analyze_model(pc, model, AnalysisConfig(top_k=15))
    print("FFA analysis completed. Outputs in:", pc.axp_output_dir)
except Exception as e:
    print("Skipping FFA: ", str(e))
```

## Outputs

- LMTP: policy-specific risks/survival and contrasts with CIs (fill in once
  nodes are engineered).
- FFA: AXPs, rule metrics, visualizations saved under
  `cohort_analysis/ffa_analysis/outputs/`.


