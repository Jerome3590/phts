---
title: "LASSO Scorecard Model with Wisotzkey Variables"
author: "R. Jerome Dixon"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 5
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
    default-image-extension: svg
    dpi: 600
---

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(readr)
library(haven)
library(purrr)
library(dplyr)
library(glmnet)
library(caret)
library(yardstick)
library(janitor)
library(lubridate)
```

## 1-Year Survival

-   Use transplants from 2010-2013 to build an lasso logistic regression model to predict 1-year survival/death using the Wisotzkey variables.

```         
1.  tx_outcome =

    tx %\>%

    transmute(

    PTID_E,

    EV_TIME = pmin(INT_DEAD, INT_GRAFT_LOSS),

    EV_TYPE = pmax(DTX_PATIENT, GRAFT_LOSS)

    ) %\>%

    mutate(

    outcome = case_when(

    EV_TYPE == 1 & EV_TIME \< 1 \~ 1L,

    EV_TYPE == 0 & EV_TIME \< 1 \~ NA_integer\_,

    .default = 0L

    )

    )

- Missing data corresponds to censoring before 1 year. We can find a better way to treat this later, but for now you can just drop transplants with missing outcome.

- For the binary predictors, don’t dummy or one-hot encode. Rather create binary (0/1) variables mapping Yes = 1 and No = 0. 

- For the thresholded numeric predictors, map N \<= thres to 0 and N \> thres to 1. In other words, there should be 15 variables in the model.

- Predict for year 2014 and evaluate using log-loss (binary cross-entropy) and brier score (MSE)
```

### Variables From Wisotzkey et al paper

![Wisotzkey Variables](images/wisotzkey_variables.png)

```{r echo=FALSE, warning=FALSE, message=FALSE}

wisotzkey_variables <- read_csv(here("data","wisotzkey_variables.csv"), show_col_types = FALSE)
wisotzkey_variables

```

### Available Datasets

```{bash echo=FALSE, warning=FALSE, message=FALSE}
ls data
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Set directory
data_dir <- here("data")

# List SAS files
sas_files <- list.files(data_dir, pattern = "\\.sas7bdat$", full.names = TRUE)

# Named list: file base names (without extension) as names
sas_data <- sas_files %>%
  set_names(~ tools::file_path_sans_ext(basename(.))) %>%
  map(read_sas)

# names of the loaded data frames
names(sas_data)
```

####  Mechanical Circulatory Support Device (MCSD) dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}

mcsd <- sas_data$mcsd %>% janitor::clean_names()

mcsd %>% 
  colnames()

```
#### Pre-Transplant Evaluation Dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}
eval <- sas_data$pretxeval %>% janitor::clean_names()

eval %>% 
  colnames()
```
#### Transplant Dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}

tx <- sas_data$transplant %>% janitor::clean_names()

tx %>% 
  colnames()
```


#### Post-Transplant Followup Dataset

```{r echo=FALSE, warning=FALSE, message=FALSE}

followups <- sas_data$posttxplfollowup %>% janitor::clean_names()

followups %>% 
  colnames()
```

### Wisotzkey Name Mapping

- Wisotzkey final variables

```{r echo=FALSE, warning=FALSE, message=FALSE}

wisotzkey_vars <- wisotzkey_variables[[1]] %>% as.character()
wisotzkey_clean <- tolower(gsub("[^a-zA-Z0-9]+", "_", wisotzkey_vars))
wisotzkey_clean

```

```{r}

# Calculate BMI, eGFR, and Listing Year
tx <- tx %>%
  mutate(
    age_listing = as.double(age_listing),
    age_txpl = as.double(age_txpl),
    bmi_txpl = (weight_txpl / (height_txpl^2)) * 703,
    egfr_tx = 0.413 * height_txpl / txcreat_r,
    listing_year = as.integer(floor(txpl_year - (age_txpl - age_listing)))
  )


```


```{r}

wisotzkey_name_map <- c(
  "primary_etiology"               = "prim_dx",
  "mcsd_at_transplant"             = "txmcsd",
  "single_ventricle_chd"           = "chd_sv",
  "surgeries_prior_to_listing"     = "hxsurg",
  "serum_albumin_at_transplant"    = "txsa_r",
  "bun_at_transplant"              = "txbun_r",
  "ecmo_at_transplant"             = "txecmo",
  "transplant_year"                = "txpl_year",
  "recipient_weight_at_transplant" = "weight_txpl",
  "alt_at_transplant"              = "txalt",
  "bmi_at_transplant"              = "bmi_txpl",     # computed
  "pra_max_at_listing"             = "lsfprat",      # fallback: use lsfprab if missing
  "egfr_at_transplant"             = "egfr_tx",      # computed from height/creatinine
  "medical_history_at_listing"     = "hxmed",
  "listing_year"                   = "listing_year"  # computed from txpl_year, age_listing, age_txpl
)

```

### LASSO Model with Transplant Dataset Only

```{r}

tx <- tx %>%
  mutate(
    ev_time = pmin(int_dead, int_graft_loss, na.rm = TRUE),
    ev_type = pmax(dtx_patient, graft_loss, na.rm = TRUE),
    outcome = case_when(
      ev_type == 1 & ev_time < 1 ~ 1L,
      ev_type == 0 & ev_time < 1 ~ NA_integer_,
      TRUE ~ 0L
    )
  ) %>%
  filter(!is.na(outcome))

# Impute values per Wisotzkey paper
tx_model <- tx %>%
  mutate(
    prim_dx = ifelse(is.na(prim_dx), "cardiomyopathy", prim_dx),
    txmcsd = ifelse(is.na(txmcsd), 0L, txmcsd),
    chd_sv = ifelse(is.na(chd_sv), 0L, chd_sv),
    hxsurg = ifelse(is.na(hxsurg), 0L, hxsurg),
    txsa_r = ifelse(is.na(txsa_r), 3.7, txsa_r),
    txbun_r = ifelse(is.na(txbun_r), 16, txbun_r),
    txecmo = ifelse(is.na(txecmo), 0L, txecmo),
    txpl_year = ifelse(is.na(txpl_year), 2015, txpl_year),
    weight_txpl = ifelse(is.na(weight_txpl), 35, weight_txpl),
    txalt = ifelse(is.na(txalt), 29, txalt),
    bmi_txpl = ifelse(is.na(bmi_txpl), 17, bmi_txpl),
    lsfprat = ifelse(is.na(lsfprat), 0, lsfprat),
    egfr_tx = ifelse(is.na(egfr_tx), 97, egfr_tx),
    hxmed = ifelse(is.na(hxmed), 1L, hxmed),
    listing_year = ifelse(is.na(listing_year), 2014, listing_year)
  ) %>%
  rename(!!!setNames(wisotzkey_name_map, names(wisotzkey_name_map))) %>%
  select(all_of(names(wisotzkey_name_map)), outcome)

```


```{r}

tx_model <- tx_model %>%
  mutate(
    serum_albumin_at_transplant_bin = as.integer(serum_albumin_at_transplant > 3.7),
    pra_max_at_listing_bin          = as.integer(pra_max_at_listing > 0),
    alt_at_transplant_bin           = as.integer(alt_at_transplant > 29),
    single_ventricle_chd_bin        = as.integer(single_ventricle_chd > 0),
    egfr_at_transplant_bin          = as.integer(egfr_at_transplant > 97),
    bun_at_transplant_bin           = as.integer(bun_at_transplant > 16),
    bmi_at_transplant_bin           = as.integer(bmi_at_transplant > 17)
  ) %>%
  relocate(
    serum_albumin_at_transplant_bin,
    pra_max_at_listing_bin,
    alt_at_transplant_bin,
    single_ventricle_chd_bin,
    egfr_at_transplant_bin,
    bun_at_transplant_bin,
    bmi_at_transplant_bin,
    .after = medical_history_at_listing
  )


# Split into training (2010–2013) and test (2014)
train <- tx_model %>% filter(transplant_year >= 2010 & transplant_year <= 2013)
test  <- tx_model %>% filter(transplant_year == 2014)

# Prepare matrices
x_train <- model.matrix(outcome ~ . - 1, train)
y_train <- train$outcome

x_test <- model.matrix(outcome ~ . - 1, test)
y_test <- test$outcome

```


```{r}

# Fit LASSO model
cvfit <- cv.glmnet(x_train, y_train, family = "binomial", alpha = 1)

# Predict and evaluate
pred_probs <- predict(cvfit, newx = x_test, s = "lambda.min", type = "response")
log_loss <- -mean(y_test * log(pred_probs) + (1 - y_test) * log(1 - pred_probs))
brier_score <- mean((pred_probs - y_test)^2)

cat("Log Loss:", round(log_loss, 4), "\n")
cat("Brier Score:", round(brier_score, 4), "\n")

```
#### Model Evaluation

```{r echo=FALSE, warning=FALSE, message=FALSE}

library(ggplot2)

# Build histogram plot of predictions grouped by actual outcome
ggplot(
  data.frame(pred = as.numeric(pred_probs), actual = factor(y_test, levels = c(0, 1), labels = c("Survived", "Died"))),
  aes(x = pred, fill = actual)
) +
  geom_histogram(position = "identity", bins = 30, alpha = 0.6) +
  labs(
    title = "Predicted Probability of Death Within 1 Year",
    x = "Predicted Probability",
    y = "Count",
    fill = "Actual Outcome"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("skyblue", "salmon"))


```

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data.frame(pred = pred_probs, actual = factor(y_test, labels = c("Survived", "Died"))),
       aes(x = actual, y = pred_probs, fill = actual)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("Survived" = "#00BFC4", "Died" = "#F8766D")) +
  labs(
    title = "Predicted Probabilities by Outcome",
    x = "Actual Outcome",
    y = "Predicted Probability"
  ) +
  theme_minimal()

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

library(ggplot2)
library(patchwork)
library(PRROC)
library(pROC)

# ROC
roc_obj <- roc(y_test, as.numeric(pred_probs))
auc_val <- auc(roc_obj)

roc_df <- data.frame(
  specificity = roc_obj$specificities,
  sensitivity = roc_obj$sensitivities
)

p1 <- ggplot(roc_df, aes(x = 1 - specificity, y = sensitivity)) +
  geom_line(color = "red", linewidth = 1.2) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  labs(
    title = paste("ROC Curve (AUC =", round(auc_val, 3), ")"),
    x = "False Positive Rate (Survived Predicted Died)",
    y = "True Positive Rate (Died)"
  ) +
  theme_minimal()

# PR
pr <- pr.curve(
  scores.class0 = pred_probs[y_test == 1],  # deaths
  scores.class1 = pred_probs[y_test == 0],  # survivors
  curve = TRUE
)

pr_df <- data.frame(Recall = pr$curve[, 1], Precision = pr$curve[, 2])

p2 <- ggplot(pr_df, aes(x = Recall, y = Precision)) +
  geom_line(color = "red", linewidth = 1.2) +
  labs(
    title = paste("PR Curve (AUC =", round(pr$auc.integral, 3), ")"),
    x = "Recall (Died)",
    y = "Precision (Died)"
  ) +
  theme_minimal()

# Combine plots
p1 + p2

```

**Model Evaluation Notes:**

- Model is learning: ROC AUC > .7 shows it can separate classes
- Imbalanced dataset, rare events: PR AUC is low due to very few True Positives (TPs)
- Model is better than random but precision drops sharply after the first few confident predictions: low number of high-confidence hits

