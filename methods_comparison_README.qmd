---
title: "Methods Comparison: graft-loss vs cohort_analysis"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    embed-resources: true
    default-image-extension: svg
    dpi: 600
editor:
  markdown:
    wrap: 72
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(here)
```


## Overview

This document summarizes methodological differences between the `graft-loss`
pipeline and the `cohort_analysis` workflow for pediatric heart transplant
outcomes, focusing on patient handling and the target outcome (survival).

## Executive summary

- **Primary distinction**: `graft-loss` models the composite survival endpoint
  (allograft loss or mortality) using full time-to-event data in a single
  cohort, then reports 1-year risks from survival curves. `cohort_analysis`
  explicitly encodes a 1-year target (status tied to <1-year events), supports
  CHD vs Myocarditis/Cardiomyopathy cohorts, and offers multiple censoring
  strategies (observed-only, guaranteed follow-up, and IPCW).
- **Which is more accurate for 1-year risk?** Prefer a proper survival model on
  the full cohort and estimate 1-year risk from the fitted survivor function
  (Cox/AORSF/CatBoost-Cox). If a binary 1-year label is required, use IPCW to
  correct for censoring; avoid dropping <1-year-censored cases.

## Patients and cohorts

- **graft-loss**
  - Includes all transplants with `TXPL_YEAR ≥ 2010`; single combined cohort.
  - Keeps censored patients; uses survival time/status fields provided in the
    dataset.

- **cohort_analysis**
  - Defines multiple analysis sets for 1-year evaluation:
    - COA1: Observed-only (drops patients censored before 1 year).
    - COA2: Restricts to `TXPL_YEAR < 2023` to guarantee 1-year follow-up.
    - COA3: Keeps all; uses IPCW to handle <1-year censoring.
  - Also analyzes clinical sub-cohorts: CHD vs Myocarditis/Cardiomyopathy.

## Outcome definition and censoring

- **graft-loss**
  - Survival endpoint: composite of allograft loss or mortality.
  - Uses `time = outcome_int_graft_loss`, `status = outcome_graft_loss`.
  - Reports 1-year incidence/risk from survival models; does not hard-truncate
    times to 1 year during preprocessing.

- **cohort_analysis**
  - Derives `ev_time = min(int_dead, int_graft_loss)` and
    `ev_type = max(dtx_patient, graft_loss)`.
  - Builds a 1-year event indicator `outcome = 1` if event occurs before 1
    year, else `0` (events after 1 year treated as censored for the 1-year
    target).
  - Censoring strategies:
    - COA1: Drop <1y censored (biased but simple).
    - COA2: Guarantee 1-year follow-up by restricting years (reduces data
      and recency).
    - COA3: IPCW using Kaplan–Meier `Ĝ(t)`: `ipcw_weight = 1 / Ĝ(t*)`.
  - Survival models use `Surv(ev_time, outcome)`; CatBoost uses signed-time
    labels (+time for events, −time for censored) with Cox loss.

## Modeling frameworks

- **graft-loss**: Compares Cox, gradient boosting (Cox loss), random survival
  forests (including oblique/AORSF). Selects AORSF; evaluates with
  time-dependent C-index via Monte-Carlo CV.

- **cohort_analysis**: Implements LASSO–Cox, CatBoost (Cox), and AORSF with a
  unified 80/20 train/test split; reports C-index across full data and cohorts.

## Feature handling and leakage control

- **graft-loss**: Drops variables with high missingness (>30%), removes
  redundant listing height/weight, recodes factors, collapses diagnoses; fixes
  zero times to a small positive value.

- **cohort_analysis**: Uses a central leakage filter to exclude outcome/temporal
  leak variables (e.g., `graft_loss`, `int_graft_loss`, `int_dead`,
  `transplant_year`), extensive factor normalization, engineered variables,
  synchronized factor levels, and imputation.

## Data preprocessing: row exclusion summary

- **graft-loss**
  - Cohort restriction only: `TXPL_YEAR ≥ 2010`.
  - Replaces zero survival times with `1/365`; does not broadly drop rows in
    cleaning.
  - `drop_na()` appears in report inline stats, not in modeling pipelines.

- **cohort_analysis**
  - 1-year label construction (COA1/COA2/COA3) uses `filter(!is.na(outcome))`,
    which removes patients censored before 1 year. This is intended for
    classification; for survival modeling, prefer retaining censored patients or
    using IPCW (COA3).
  - Year restriction in COA2 (`txpl_year < 2023`) reduces sample size/recency by
    design.
  - Survival data cleaning removes rows with non-finite/missing or non-positive
    `ev_time`/`status`. Mitigated by prior step that replaces non-positive
    censored times with a median value; ensure that fix runs before any
    `time > 0` filters.

- **Safeguards**
  - Log pre/post row counts at each filtering step.
  - For survival analyses, avoid `filter(!is.na(outcome))`; keep censored
    observations or apply IPCW.
  - Ensure non-positive time fixes precede strict time/status filters; keep a
    small epsilon for times when required by the learner.

## Practical implications

- `graft-loss` leverages full time-to-event information for the composite
  endpoint and derives 1-year risk from survival curves in a global cohort.
- `cohort_analysis` enforces a 1-year target labeling scheme (with optional
  IPCW), enabling direct classification-style comparisons and cohort-specific
  insights (CHD vs Myo/Cardio).

## Recommendation

- For 1-year risk estimation, fit a survival model on all available follow-up
  (Cox/AORSF/CatBoost–Cox) and report 1-year risks from the survivor function.
- When binary labels are necessary, construct 1-year labels and apply IPCW to
  correct for censoring; avoid discarding <1-year-censored patients.
- Stratify or adjust for CHD vs Myo/Cardio to capture cohort-specific effects.

## Why prefer time-to-event over classification for 1-year risk

- **Proper censoring**: Survival models natively handle right-censoring; classifiers either drop <1-year-censored patients (bias) or require IPCW (adds variance, depends on correct censoring model).
- **Use all information**: Survival uses actual event times and full follow-up. Classification discards timing and marks events after 1 year as non-events, losing signal and potentially mislabeling.
- **Statistical efficiency**: Censored observations contribute information in survival models; observed-only classification wastes data and reduces power.
- **Flexible horizons**: A single survival model yields risk at any horizon (e.g., 90 days, 1, 3 years); classification needs separate models/thresholds per horizon.
- **Calibration and transportability**: Cox/AORSF support principled calibration as event rates shift; classification is sensitive to prevalence and the chosen window (e.g., COA2 year cuts).
- **Clinical interpretability**: Survival outputs (hazard ratios, survival curves) align with clinical decision-making better than thresholded probabilities.
- **Extensibility**: Survival frameworks extend to competing risks and dynamic prediction; classification does not.

## Harmonization checklist (optional)

- Align status definition across pipelines (survival-based risk at 1 year vs
  explicit 1-year labels).
- Standardize censoring treatment (e.g., IPCW or guaranteed follow-up window).
- Apply a shared leakage filter and consistent cohort definitions.
- Compare models with the same train/test splits and metrics (C-index).

## Pointers to code

- `graft-loss/R/plan.R`: sets `time = outcome_int_graft_loss`,
  `status = outcome_graft_loss`.
- `graft-loss/R/clean_phts.R`: cohort filter (`TXPL_YEAR ≥ 2010`), cleaning,
  small-time fix for zeros.
- `cohort_analysis/phts_dataset.qmd`: constructs `ev_time`, `ev_type`, and
  1-year `outcome`; COA1/COA2/COA3 definitions (incl. IPCW).
- `cohort_analysis/survival_analysis.qmd` and
  `cohort_analysis/cohort_survival_analysis.qmd`: survival pipelines (LASSO–Cox,
  CatBoost–Cox, AORSF), cohort splits, and unified evaluation.



